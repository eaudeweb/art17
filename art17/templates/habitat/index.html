{% extends "layout.html" %}


{% block title %}
{%- if habitat %}{{ habitat.name }} &mdash; {% endif %}
{{- super() }}
{%- endblock title %}


{% block content %}
  <form class="habitatfilter">
    <fieldset>
      <legend>Filtrare habitate</legend>

      <div class="form-group">
        <label for="habitatfilter-group">Habitat</label>
        <input name="habitat" value="{{ current_habitat_code or '' }}"
               type="hidden" id="habitatfilter-group">
      </div>

      <div class="form-group">
        <label for="habitatfilter-region">Regiune</label>
        <input name="region" value="{{ current_region_code }}"
               type="hidden" id="habitatfilter-region">
      </div>

      <div class="form-group">
        <button type="submit">filtreazÄƒ</button>
      </div>
    </fieldset>
  </form>

 {% if habitat %}
  <p>
    <strong>{{ habitat.name }}</strong>,
    cod: {{ habitat.code }}
  </p>

  {%- include 'habitat/records.html' with context %}
 {% endif %}
{% endblock content %}


{% block script %}
  {%- from 'bits.html' import script %}
  {{ super() }}
  {{ script('detail.js') }}
  {{ script('comments.js') }}

  <script>
    (function() {
      "use strict";

      var habitatfilter = $('.habitatfilter');
      var habitat_list = {{ habitat_list|tojson|safe }};

      habitatfilter.find('[name=habitat]').select2({
        data: habitat_list,
        width: '40em'
      });

      var region_select = habitatfilter.find('[name=region]');

      function update_region_select() {
        var habitat_code = habitatfilter.find('[name=habitat]').select2('val');
        if(! habitat_code) {
          region_select.select2('destroy');
          return;
        }
        region_select.select2('val', '');
        var url = 'regiuni/' + habitat_code;
        $.get(url, function(resp) {
          region_select.select2('destroy').select2({
            data: [{id: '', text: "toate"}].concat(resp.regions),
            width: '15em'
          });
        });
      };

      update_region_select();

      habitatfilter.on('change', '[name=habitat]', function() {
        update_region_select();
      });
    })();
  </script>
{% endblock script %}

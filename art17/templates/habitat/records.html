{%- from 'common/td.html'
    import conclusion_td, reference_value_td, trend_td, conclusion_td_input
    with context %}
{%- from 'bits.html' import fonticon %}


{% macro record_cells(row) %}
  {#- bio-regiune #}
  <td>{{ row.region }}</td>

  {#- range #}
  {%- set range = row.range %}
  <td>{{ range.surface_area }}</td>
  <td class="method">{{ range.method }}</td>
  {{ trend_td(range.trend_short) }}
  {{ reference_value_td(range.reference_value) }}
  {{ conclusion_td(range.conclusion) }}

  {#- coverage #}
  {%- set coverage = row.coverage %}
  <td>{{ coverage.surface_area }}</td>
  <td class="method">{{ coverage.method }}</td>
  {{ trend_td(coverage.trend_short) }}
  {{ reference_value_td(coverage.reference_value) }}
  {{ conclusion_td(coverage.conclusion) }}

  {#- structure #}
  {{ conclusion_td(row.structure) }}

  {#- future prospects #}
  {{ conclusion_td(row.future_prospects) }}

  {#- overall assessment #}
  {{ conclusion_td(row.overall_assessment) }}
{%- endmacro %}

<table class="records">
  <tr class="records-header">
    <th rowspan=2></th>
    <th rowspan=2 title="Regiunea biogeografică">Bio</th>
    <th colspan=5
        title="Proporția habitatului din regiunea biogeografică">Areal</th>
    <th colspan=5
        title="Suprafața acoperită de habitat (km²)">Suprafața (km²)</th>
    <th rowspan=2
        title="Structura și funcțiile specifice">Struct.<br>și func.</th>
    <th rowspan=2
        title="Perspective viitoare"
        >Perspective</th>
    <th rowspan=2
        title="Evaluare generală a stării de conservare"
        >Evaluare<br>generală</th>
    <th rowspan=2 colspan=4></th>  {#- conclusion (author, etc) #}
  </tr>

  <tr class="records-header">
    {#- detail #}
    {#- bio-regiune #}

    {#- range #}
    <th title="Suprafața">Supr.</th>
    <th title="Metoda folositǎ">Met.</th>
    <th title="Tendința areal pe termen scurt">Tend.<br>t.scurt</th>
    <th title="Arealul favorabil de referință">Ref.</th>
    <th title="Concluzie">Concl.</th>

    {#- coverage #}
    <th title="Suprafața">Supr.</th>
    <th title="Metoda folositǎ">Met.</th>
    <th title="Tendința suprafața pe termen scurt">Tend.<br>t.scurt</th>
    <th title="Suprafața de referință favorabilǎ">Ref.</th>
    <th title="Concluzie">Concl.</th>

    {#- structure #}
    {#- future prospects #}
    {#- overall assessment #}
  </tr>

 {% for row in records %}
  <tr>
    {#- detail #}
    <td>
      {%- set url = url_for('.detail', record_id=row.id) %}
      <button class="records-detailbtn" data-url="{{ url }}">detalii</button>
    </td>

    {{ record_cells(row) }}

    <td colspan=4>  {#- conclusion (author, etc) #}
      {%- if perm_create_conclusion(row) %}
        {%- set url = url_for('.conclusion', record_id=row.id,
                                             next=conclusion_next) %}
        <a class="records-conclusionbtn" href="{{ url }}">adaugǎ concluzie</a>
      {%- endif %}
    </td>
  </tr>
 {% endfor %}

  <tr class="records-header">
    <th colspan=19>Concluzii</th>
  </tr>

 {% for row in conclusions %}
  <tr>
    {#- detail #}
    <td>
      {%- if can_update_conclusion_status %}
        {%- set url = url_for('.conclusion_status', conclusion_id=row.id) %}
        <form method="post" action="{{ url }}" class="records-conclusionstatus">
          <input type="hidden" name="next" value="{{ conclusion_next }}">
          <input type="hidden" name="status" value="{{ row.status }}">
        </form>
      {%- endif %}

      {%- if can_delete_conclusion %}
        {%- set url = url_for('.conclusion_delete', conclusion_id=row.id) %}
        <form method="post" action="{{ url }}" class="records-conclusiondelete">
          <input type="hidden" name="next" value="{{ conclusion_next }}">
          <button class="btn btn-xs btn-danger"
                  type="submit">{{ fonticon('trash') }}</button>
        </form>
      {%- endif %}
    </td>

    {{ record_cells(row) }}

    <td>{{ row.user_id }}</td>  {#- conclusion author, etc #}
    <td>
      {%- if perm_edit_conclusion(row.model) %}
        {%- set url = url_for('.conclusion_edit', conclusion_id=row.id,
                                               next=conclusion_next) %}
        <a href="{{ url }}" class="records-editconclusionbtn">edit</a>
      {%- endif %}
    </td>
    <td>{{ row.conclusion_date|local_date }}</td>
    <td>
      {%- set url = url_for('messages.index', conclusion_id=row.id) %}
      {%- set count = message_counts[row.id] or 0 %}
      <a class="records-messagesbtn btn btn-xs btn-default"
         href="{{ url }}">{{ fonticon('comment') }} {{ count }}</a>
    </td>
  </tr>
 {% endfor %}
</table>


{% include 'common/recorddetail.html' %}

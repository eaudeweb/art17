{%- from 'bits.html' import fonticon %}


{% macro topic_html(
    assessment_row,
    comments,
    topic_template,
    blueprint) %}
  {%- from topic_template import
      assessment_header, comments_header, record
      with context -%}

  <table class="records table table-bordered">
    {{ assessment_header() }}

    <tr>
      {#- detail #}
      <td>
        {%- set url = url_for(blueprint + '.detail',
                              record_id=assessment_row.id) %}
        <button class="records-detailbtn btn btn-xs btn-info"
                data-url="{{ url }}">detalii</button>
      </td>

      {{ record(assessment_row) }}

      <td colspan=4>  {#- conclusion (author, etc) #}
        {%- if perm_create_comment(assessment_row['model']).can() %}
          {%- set url = url_for(blueprint + '.comment',
                                record_id=assessment_row.id,
                                next=comment_next) %}
          <a class="records-commentbtn btn btn-xs btn-warning"
             href="{{ url }}">adaugǎ comentariu</a>
        {%- endif %}
      </td>
    </tr>

    {{ comments_header() }}

   {% for comment_row in comments %}
   {% if comment_row.region == assessment_row.region %}
    <tr>
      {#- detail #}
      <td>
        {%- if perm_update_comment_status(comment_row.model).can() %}
          {%- set url = url_for(blueprint + '.comment_status',
                                comment_id=comment_row.id) %}
          <form method="post" action="{{ url }}"
                class="records-commentstatus">
            <input type="hidden" name="next" value="{{ comment_next }}">
            <input type="hidden" name="status" value="{{ comment_row.status }}">
          </form>
        {%- endif %}
      </td>

      {{ record(comment_row) }}

      <td>{{ comment_row.cons_user_id }}</td>  {#- conclusion author, etc #}
      <td>
        {%- if perm_edit_comment(comment_row.model).can() %}
          {%- set url = url_for(blueprint + '.comment_edit',
                                comment_id=comment_row.id,
                                next=comment_next) %}
          <a class="records-editcommentbtn btn btn-xs btn-default"
             href="{{ url }}">editează</a>
        {%- endif %}

        {%- if perm_delete_comment(comment_row.model).can() %}
          {%- set url = url_for(blueprint + '.comment_delete',
                                comment_id=comment_row.id) %}
          <form method="post" action="{{ url }}"
                class="records-commentdelete">
            <input type="hidden" name="next" value="{{ comment_next }}">
            <button class="btn btn-xs btn-danger"
                    type="submit">șterge</button>
          </form>
        {%- endif %}
      </td>
      <td>{{ comment_row.comment_date|local_date }}</td>
      <td>
        {%- set url = url_for(
              'replies.index',
              parent_table=blueprint,
              parent_id=comment_row.id,
            ) %}
        {%- set count = reply_counts[comment_row.id|string] or 0 %}
        <a class="records-repliesbtn btn btn-xs btn-default"
           href="{{ url }}">{{ fonticon('comment') }} {{ count }}</a>
      </td>
    </tr>
   {% endif %}
   {% endfor %}
  </table>
{%- endmacro %}


{% macro topic_html_aggregation(
    assessment_row,
    type,
    topic_template) %}
  {%- from topic_template import
      assessment_header, comments_header, record
      with context -%}

  <table class="records table table-bordered">
    {{ assessment_header() }}

    <tr>
      {#- detail #}
      <td>
        {%- set url = url_for('.detail-' + type,
                              record_id=assessment_row.id) %}
        <button class="records-detailbtn btn btn-xs btn-info"
                data-url="{{ url }}">detalii</button>
      </td>

      {{ record(assessment_row) }}

      <td colspan=4>  {#- conclusion (author, etc) #}
        {%- set url = url_for('.' + type + '-edit',
                              dataset_id=dataset_id,
                              record_id=assessment_row.id) %}
        <a class="btn btn-xs btn-default"
           href="{{ url }}">edit</a>
      </td>
    </tr>
  </table>
{%- endmacro %}

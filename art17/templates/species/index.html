{% extends "layout.html" %}


{% macro conclusion_td(conclusion) -%}
  <td class="conclusion-{{ conclusion }}">{{ conclusion }}</td>
{%- endmacro %}


{% macro reference_value_td(refval) -%}
  <td {% if refval.method -%}
        title="Metoda utilizată: {{ refval.method }}"
      {%- endif %}>
    {{- refval.value -}}
  </td>
{%- endmacro %}


{% set trend_name = {
    "+": "În creștere",
    "-": "În scădere",
    "0": "Stabil",
    "x": "Necunoscut",
  } %}


{% macro trend_td(trend) -%}
  {%- set tooltip = trend_name[trend.trend] %}
  <td class="trend" title="{{ tooltip }}">
    {{- trend.trend }}<br>{{ trend.period -}}
  </td>
{%- endmacro %}


{% block content %}
  <form class="speciesfilter">
    <fieldset>
      <legend>Filtrare specii</legend>

      <div class="form-group">
        <label for="speciesfilter-group">Grup</label>

        <select name="group" id="speciesfilter-group">
          <option value="">--</option>

          {% for group in species_groups %}
            {% set selected = (group == current_group) %}
            <option value="{{ group.code }}"
                    {%- if selected %} selected{% endif %}>
              {{- group.description -}}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="speciesfilter-species">Specie</label>

        <select name="species" id="speciesfilter-species">
          <option value="">--</option>

          {% for species in species_list %}
            {% set selected = (species == current_species) %}
            <option value="{{ species.speciescode }}"
                    {%- if selected %} selected{% endif %}>
              {{- species.speciesname -}}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <button type="submit">filtrează</button>
      </div>
    </fieldset>
  </form>

 {% if species %}
  <p>
    {%- set annex_list =
      (["II"] if species.annex_II else []) +
      (["IV"] if species.annex_IV else []) +
      (["V"] if species.annex_V else []) %}

    <strong>{{ species.name }}</strong>,
    cod: {{ species.code }},
    anexe: {{ ", ".join(annex_list) if annex_list else "--" }}
  </p>
 {% endif %}

  <hr>

  <table class="records">
    <tr class="records-header">
      <td rowspan=2 title="Regiunea biogeografică">Regiune</td>
      <td colspan=5>Areal (km<sup>2</sup>)</td>
      <td colspan=5>Populație</td>
      <td colspan=7>Habitat pentru specie (km<sup>2</sup>)</td>
      <td rowspan=2
          title="Perspective (referitoare la populație, areal și
                 disponibilitatea habitatului)"
          >Perspective</td>
      <td rowspan=2
          title="Evaluare generală a statutului de conservare"
          >Evaluare generală</td>
    </tr>

    <tr class="records-header">
      {#- bio-regiune #}
      {#- range: 5 cols #}
      <td>Metodă</td>
      <td>Suprafață</td>
      <td>Concluzie</td>
      <td>Tendință</td>
      <td title="Arealul favorabil de referință">Referință</td>
      {#- population: 5 cols #}
      <td title="Mărimea populației și unitatea de măsură">Mărime</td>
      <td>Concluzie</td>
      <td>Tendință pe termen scurt</td>
      <td>Tendință pe termen lung</td>
      <td title="Populația favorabilă de referință">Referință</td>
      {#- habitat: 7 cols #}
      <td>Metodă</td>
      <td>Suprafață</td>
      <td>Concluzie</td>
      <td>Tendință pe termen scurt</td>
      <td>Tendință pe termen lung</td>
      <td title="Zona de referință favorabilă">Referință</td>
      <td>Calitate</td>
      {#- future prospects #}
      {#- overall assessment #}
    </tr>

   {% for row in species.records %}
    <tr>
      {#- bio-regiune #}
      <td>{{ row.region }}</td>

      {#- range: 5 cols #}
      {%- set range = row.range %}
      <td>{{ range.method }}</td>
      <td>{{ range.surface_area }}</td>
      {{ conclusion_td(range.conclusion) }}
      {{ trend_td(range.trend) }}
      {{ reference_value_td(range.reference_value) }}

      {#- population: 5 cols #}
      {%- set population = row.population %}
      <td>{{ population.size_and_unit }}</td>
      {{ conclusion_td(population.conclusion) }}
      {{ trend_td(population.trend_short) }}
      {{ trend_td(population.trend_long) }}
      {{ reference_value_td(population.reference_value) }}

      {#- habitat: 7 cols #}
      {%- set habitat = row.habitat %}
      <td>{{ habitat.method }}</td>
      <td>{{ habitat.surface_area }}</td>
      {{ conclusion_td(habitat.conclusion) }}
      {{ trend_td(habitat.trend_short) }}
      {{ trend_td(habitat.trend_long) }}
      <td>{{ habitat.area_suitable }}</td>
      <td>{{ habitat.quality }}</td>

      {#- future prospects #}
      <td>{{ row.future_prospects }}</td>

      {#- overall assessment #}
      <td>{{ row.overall_assessment }}</td>
    </tr>
   {% endfor %}
  </table>
{% endblock content %}


{% block styles %}
  {{ super() }}
  {% from 'bits.html' import link %}
  {{ link('lib/select2-3.4.2/select2.css') }}
{% endblock styles %}


{% block script %}
  {{ super() }}
  {% from 'bits.html' import script %}
  {{ script('lib/select2-3.4.2/select2.min.js') }}
  {{ script('lib/select2-3.4.2/select2_locale_ro.js') }}

  <script>
    (function() {
      var speciesfilter = $('.speciesfilter');

      speciesfilter.find('select[name=species]').select2({width: '25em'});
    })();
  </script>
{% endblock script %}
